# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - main

pool:
 name: 'Azure Pipelines'

variables:
  azureServiceConnection: 'Myconnectionactive'
  subscriptionId: '12486a52-70e3-4ae6-9f94-e6bacd147419'
  resourceGroup: 'demonewtest_group'
  location: 'canadacentral'

  # Update to your actual repo paths (case-sensitive)
  templateRelPath: 'infra/template.json'
  parametersRelPath: 'infra/parameters.json'

stages:
- stage: Deploy
  displayName: Deploy Logic App (Single Env)
  jobs:
  - job: ARM
    displayName: ARM Template Deployment
    steps:
    - checkout: self

    # Verify files exist where we think they do
    - script: |
        echo "Workspace: $(Build.SourcesDirectory)"
        ls -R "$(Build.SourcesDirectory)"
        echo "Expecting:"
        echo "  $(Build.SourcesDirectory)/$(templateRelPath)"
        echo "  $(Build.SourcesDirectory)/$(parametersRelPath)"
        test -f "$(Build.SourcesDirectory)/$(templateRelPath)" || (echo "Template NOT found" && exit 1)
        test -f "$(Build.SourcesDirectory)/$(parametersRelPath)" || (echo "Parameters NOT found" && exit 1)
      displayName: Verify files are present

    # Preflight (optional)
    - task: AzureCLI@2
      displayName: Preflight checks
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -e
          echo "Validating resource group exists..."
          az group show -n $(resourceGroup) --query name -o tsv
          echo "Ensuring providers are registered..."
          az provider register --namespace Microsoft.Logic
          az provider register --namespace Microsoft.Web
          echo "Preflight OK"

    - task: AzureResourceManagerTemplateDeployment@3
      displayName: Deploy Logic App (Consumption)
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: '$(azureServiceConnection)'
        subscriptionId: '$(subscriptionId)'
        action: 'Create Or Update Resource Group'
        resourceGroupName: '$(resourceGroup)'
        location: '$(location)'
        templateLocation: 'Linked artifact'
        # Use explicit absolute paths anchored to the workspace
        csmFile: '$(Build.SourcesDirectory)/$(templateRelPath)'
        csmParametersFile: '$(Build.SourcesDirectory)/$(parametersRelPath)'
        deploymentMode: 'Incremental'

    # Post‑deploy presence check (optional)
    - task: AzureCLI@2
      displayName: Post‑deploy check
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Logic Apps in $(resourceGroup):"
          az resource list \
            --resource-group $(resourceGroup) \
            --resource-type "Microsoft.Logic/workflows" \
