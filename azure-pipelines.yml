# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - main

pool:
 name: 'Azure Pipelines'


variables:
  azureServiceConnection: 'Myconnectionactive'        # DevOps Service Connection to Azure
  subscriptionId: '12486a52-70e3-4ae6-9f94-e6bacd147419'
  resourceGroup: 'demonewtest_group'
  location: 'canadacentral'                   # your template pins this region

  # Relative paths inside your GitHub repo
  templateFile: 'path/to/template.json'       # e.g., infra/template.json
  parametersFile: 'path/to/parameters.json'   # e.g., infra/parameters.json

stages:
- stage: Deploy
  displayName: Deploy Logic App (Single Env)
  jobs:
  - job: ARM
    displayName: ARM Template Deployment
    steps:
    - checkout: self

    # (Optional) Preflight to validate RG & providers
    - task: AzureCLI@2
      displayName: Preflight checks
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: bash
        scriptLocation: inlineScript
      # Feel free to remove if you don’t want preflight
      inlineScript: |
        set -e
        echo "Validating resource group exists..."
        az group show -n $(resourceGroup) --query name -o tsv
        echo "Ensuring providers are registered..."
        az provider register --namespace Microsoft.Logic
        az provider register --namespace Microsoft.Web
        echo "Preflight OK"

    - task: AzureResourceManagerTemplateDeployment@3
      displayName: Deploy Logic App (Consumption)
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: '$(azureServiceConnection)'
        subscriptionId: '$(subscriptionId)'
        action: 'Create Or Update Resource Group'
        resourceGroupName: '$(resourceGroup)'
        location: '$(location)'
        templateLocation: 'Linked artifact'
        csmFile: '$(templateFile)'
        csmParametersFile: '$(parametersFile)'
        deploymentMode: 'Incremental'

    # (Optional) Post‑deploy presence check
    - task: AzureCLI@2
      displayName: Post‑deploy check
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: bash
        scriptLocation: inlineScript
      inlineScript: |
        # Derive the Logic App name from parameters.json (if fixed), otherwise skip
        echo "Listing Logic Apps in RG to confirm deployment..."
        az resource list \
          --resource-group $(resourceGroup) \
          --resource-type "Microsoft.Logic/workflows" \

